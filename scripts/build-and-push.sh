#!/bin/bash
# Script para construir y subir im√°genes a GitHub Container Registry (GHCR)

set -e

GITHUB_USER="daviddlv007"
REGISTRY="ghcr.io"

echo "üîê Haciendo login en GHCR..."
./scripts/ghcr-login.sh

echo ""
echo "üèóÔ∏è  Construyendo Service A..."
docker build -t ${REGISTRY}/${GITHUB_USER}/service-a:latest services/service-a/

echo ""
echo "üèóÔ∏è  Construyendo Service B..."
docker build -t ${REGISTRY}/${GITHUB_USER}/service-b:latest services/service-b/

echo ""
echo "üì§ Subiendo Service A a GHCR..."
docker push ${REGISTRY}/${GITHUB_USER}/service-a:latest

echo ""
echo "üì§ Subiendo Service B a GHCR..."
docker push ${REGISTRY}/${GITHUB_USER}/service-b:latest

echo ""
echo "‚úÖ Im√°genes publicadas exitosamente!"
echo ""

# Hacer las im√°genes p√∫blicas autom√°ticamente
echo "üåê Haciendo im√°genes p√∫blicas..."

# Obtener token de archivo seguro
if [ -f ~/.ghcr_token ]; then
    GITHUB_TOKEN=$(cat ~/.ghcr_token)
    
    # Hacer service-a p√∫blico
    echo "   - Haciendo service-a p√∫blico..."
    curl -s -X PATCH \
      -H "Authorization: Bearer ${GITHUB_TOKEN}" \
      -H "Accept: application/vnd.github.v3+json" \
      "https://api.github.com/user/packages/container/service-a" \
      -d '{"visibility":"public"}' > /dev/null 2>&1

    # Hacer service-b p√∫blico
    echo "   - Haciendo service-b p√∫blico..."
    curl -s -X PATCH \
      -H "Authorization: Bearer ${GITHUB_TOKEN}" \
      -H "Accept: application/vnd.github.v3+json" \
      "https://api.github.com/user/packages/container/service-b" \
      -d '{"visibility":"public"}' > /dev/null 2>&1
else
    echo "‚ö†Ô∏è  Saltando hacer im√°genes p√∫blicas (archivo ~/.ghcr_token no encontrado)"
    echo "üí° Para hacerlas p√∫blicas autom√°ticamente, guarda tu token en ~/.ghcr_token"
fi

echo ""
echo "‚úÖ Todo listo! Im√°genes p√∫blicas disponibles en:"
echo "   - ${REGISTRY}/${GITHUB_USER}/service-a:latest"
echo "   - ${REGISTRY}/${GITHUB_USER}/service-b:latest"
