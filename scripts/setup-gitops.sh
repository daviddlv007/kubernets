#!/bin/bash
# Setup GitOps autom√°tico como servicio systemd

set -e

echo "üöÄ Configurando GitOps Autom√°tico"
echo ""

# Verificar que los clusters existen
echo "1Ô∏è‚É£  Verificando clusters..."
kubectl config use-context k3d-cluster1 >/dev/null 2>&1 || {
    echo "‚ùå Error: cluster1 no existe"
    echo "üí° Ejecuta: make create-clusters"
    exit 1
}

kubectl config use-context k3d-cluster2 >/dev/null 2>&1 || {
    echo "‚ùå Error: cluster2 no existe"
    echo "üí° Ejecuta: make create-clusters"
    exit 1
}

echo "   ‚úÖ Clusters encontrados"
echo ""

# Desplegar servicios inicialmente
echo "2Ô∏è‚É£  Despliegue inicial..."
kubectl config use-context k3d-cluster1
kubectl apply -f services/service-a/k8s/
echo "   ‚úÖ Service A desplegado en cluster1"

kubectl config use-context k3d-cluster2
kubectl apply -f services/service-b/k8s/
echo "   ‚úÖ Service B desplegado en cluster2"
echo ""

# Configurar como servicio systemd
echo "3Ô∏è‚É£  Configurando servicio systemd..."

# Copiar el service file
sudo cp scripts/gitops.service /etc/systemd/system/

# Reload systemd
sudo systemctl daemon-reload

# Habilitar servicio para inicio autom√°tico
sudo systemctl enable gitops.service

# Iniciar servicio
sudo systemctl start gitops.service

echo "   ‚úÖ Servicio configurado e iniciado"
echo ""

# Mostrar estado
echo "4Ô∏è‚É£  Estado del servicio:"
sudo systemctl status gitops.service --no-pager | head -15
echo ""

echo "‚úÖ GitOps Autom√°tico configurado!"
echo ""
echo "üìã Comandos √∫tiles:"
echo "   Ver logs:      sudo journalctl -u gitops -f"
echo "   Estado:        sudo systemctl status gitops"
echo "   Detener:       sudo systemctl stop gitops"
echo "   Reiniciar:     sudo systemctl restart gitops"
echo "   Deshabilitar:  sudo systemctl disable gitops"
echo ""
echo "üéØ Workflow desde ahora:"
echo "   1. Editas c√≥digo localmente"
echo "   2. git add . && git commit -m 'mensaje'"
echo "   3. git push"
echo "   4. ¬°El servicio despliega autom√°ticamente en ~30s!"
